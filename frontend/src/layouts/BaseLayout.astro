---
import '../styles/fonts.css';
import '../styles/global.css';
import PublicNavigation from '../components/layout/PublicNavigation';
import { buildServerApiUrl } from '../lib/api/server';

type Props = {
    title?: string;
    description?: string;
    navigationMode?: 'auto' | 'public' | 'admin' | 'none';
};

const {
    title = 'Spacegurumis',
    description = 'Spacegurumis',
    navigationMode = 'auto',
} = Astro.props as Props;

const pathname = Astro.url.pathname;
const inferredNavigationMode =
    pathname.startsWith('/admin') || pathname === '/admin-2fa'
        ? 'admin'
        : 'public';
const resolvedNavigationMode =
    navigationMode === 'auto' ? inferredNavigationMode : navigationMode;

let initialPublicAuthenticated = false;
if (resolvedNavigationMode === 'public') {
    const cookieHeader = Astro.request.headers.get('cookie');
    if (cookieHeader) {
        try {
            const profileUrl = buildServerApiUrl(Astro.url, '/api/v1/profile');
            const profileOrigin = new URL(profileUrl).origin;
            if (profileOrigin === Astro.url.origin) {
                const response = await fetch(profileUrl, {
                    method: 'GET',
                    headers: {
                        Accept: 'application/json',
                        Cookie: cookieHeader,
                    },
                });
                initialPublicAuthenticated = response.ok;
            }
        } catch {
            initialPublicAuthenticated = false;
        }
    }
}
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>{title}</title>
        <meta name="description" content={description} />
        <link rel="icon" href="/alien.ico" sizes="any" />
    </head>
    <body class={`layout layout--${resolvedNavigationMode}`}>
        <a class="skip-link" href="#main">Saltar al contenido</a>

        <header class="site-header">
            <div class="container site-header__inner">
                <a class="brand" href="/" data-nav-prefetch>
                    <span class="brand__mark" aria-hidden="true">
                        <img src="/alienprincipal.png" alt="" class="brand__logo" />
                    </span>
                    <span class="brand__text">Spacegurumis</span>
                </a>

                {
                    resolvedNavigationMode === 'public' ? (
                        <PublicNavigation
                            client:load
                            initialAuthenticated={initialPublicAuthenticated}
                        />
                    ) : null
                }

                {
                    resolvedNavigationMode === 'admin' ? (
                        <nav class="nav nav--admin" aria-label="Navegacion admin">
                            <a class="nav__link" href="/" data-nav-prefetch>Ver tienda</a>
                            <a class="nav__link nav__link--cta" href="/admin" data-nav-prefetch>Panel admin</a>
                        </nav>
                    ) : null
                }
            </div>
        </header>

        <main id="main" class="container">
            <slot />
        </main>

        <footer class="site-footer">
            <div class="container site-footer__inner">
                <p class="muted">Â© {new Date().getFullYear()} Spacegurumis</p>
            </div>
        </footer>

        <script type="module">
            import { initAcceleratedNavigation } from '../lib/navigation/acceleratedNavigation';

            initAcceleratedNavigation();
        </script>
    </body>
</html>
