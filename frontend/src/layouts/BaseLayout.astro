---
import '../styles/fonts.css';
import '../styles/global.css';
import PublicNavigation from '../components/layout/PublicNavigation';
import { probePublicSession, type PublicSessionSnapshot } from '../lib/session/publicSession.server';

type Props = {
    title?: string;
    description?: string;
    navigationMode?: 'auto' | 'public' | 'admin' | 'none';
};

const {
    title = 'Spacegurumis',
    description = 'Spacegurumis',
    navigationMode = 'auto',
} = Astro.props as Props;

const pathname = Astro.url.pathname;
const inferredNavigationMode =
    pathname.startsWith('/admin') || pathname === '/admin-2fa'
        ? 'admin'
        : 'public';
const resolvedNavigationMode =
    navigationMode === 'auto' ? inferredNavigationMode : navigationMode;

let initialPublicSession: PublicSessionSnapshot = 'unknown';
if (resolvedNavigationMode === 'public') {
    initialPublicSession = await probePublicSession({
        requestUrl: Astro.url,
        cookieHeader: Astro.request.headers.get('cookie'),
    });
}
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>{title}</title>
        <meta name="description" content={description} />
        <link rel="icon" href="/alien.ico" sizes="any" />
    </head>
    <body class={`layout layout--${resolvedNavigationMode}`}>
        <a class="skip-link" href="#main">Saltar al contenido</a>

        <header class="site-header">
            <div class="container site-header__inner">
                <a class="brand" href="/" data-nav-prefetch>
                    <span class="brand__mark" aria-hidden="true">
                        <img src="/alienprincipal.png" alt="" class="brand__logo" />
                    </span>
                    <span class="brand__text">Spacegurumis</span>
                </a>

                {
                    resolvedNavigationMode === 'public' ? (
                        <PublicNavigation
                            client:load
                            initialSession={initialPublicSession}
                        />
                    ) : null
                }

                {
                    resolvedNavigationMode === 'admin' ? (
                        <nav class="nav nav--admin" aria-label="Navegacion admin">
                            <a class="nav__link" href="/" data-nav-prefetch>Ver tienda</a>
                            <a class="nav__link nav__link--cta" href="/admin" data-nav-prefetch>Panel admin</a>
                        </nav>
                    ) : null
                }
            </div>
        </header>

        <main id="main" class="container">
            <slot />
        </main>

        <footer class="site-footer">
            <div class="container site-footer__inner">
                <section class="site-footer__brand" aria-labelledby="footer-brand-heading">
                    <h2 id="footer-brand-heading" class="site-footer__title">
                        Spacegurumis
                    </h2>
                    <p class="muted">
                        Tejemos amigurumis con detalle artesanal para cada aventura.
                    </p>
                </section>

                <nav class="site-footer__column" aria-label="Navegacion tienda">
                    <h2 class="site-footer__title">Tienda</h2>
                    <a href="/shop" data-nav-prefetch>Tienda</a>
                    <a href="/shop" data-nav-prefetch>Colecciones</a>
                    <a href="/special-orders" data-nav-prefetch>Pedidos especiales</a>
                </nav>

                <nav class="site-footer__column" aria-label="Ayuda y soporte">
                    <h2 class="site-footer__title">Ayuda</h2>
                    <a href="/about" data-nav-prefetch>Sobre nosotros</a>
                    <a href="/contact" data-nav-prefetch>Contactanos</a>
                    <a href="/care-instructions" data-nav-prefetch>Instrucciones de cuidado</a>
                </nav>

                <section class="site-footer__column site-footer__newsletter" aria-labelledby="footer-newsletter-heading">
                    <h2 id="footer-newsletter-heading" class="site-footer__title">Newsletter</h2>
                    <p class="muted">
                        Suscribete para recibir novedades de modelos y drops semanales.
                    </p>
                    <form class="site-footer__newsletter-form" action="#" method="post" onsubmit="return false">
                        <label for="footer-newsletter-email" class="sr-only">Correo</label>
                        <input
                            id="footer-newsletter-email"
                            type="email"
                            name="email"
                            placeholder="tu-correo@ejemplo.com"
                            autocomplete="email"
                        />
                        <button type="submit" class="button button--primary">
                            Suscribirme
                        </button>
                    </form>
                </section>
            </div>
            <p class="container site-footer__legal muted">
                Â© {new Date().getFullYear()} Spacegurumis. Todos los derechos reservados.
            </p>
        </footer>

        <script type="module">
            import { initAcceleratedNavigation } from '../lib/navigation/acceleratedNavigation';

            initAcceleratedNavigation();
        </script>
    </body>
</html>
